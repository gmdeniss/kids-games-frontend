<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bug Busters üêû</title>
<link rel="stylesheet" href="../../assets/styles.css" />
<style>
  .hud{display:flex;justify-content:space-between;gap:16px;margin:8px 0 12px}
  .playfield{position:relative;width:min(640px,90vw);height:min(420px,63vw);margin:0 auto;border:2px dashed #333;background:repeating-linear-gradient(135deg,#0000 0 10px,#0001 10px 20px)}
  #bug{position:absolute;transform:translate(-50%,-50%);width:56px;height:56px;border-radius:50%;display:grid;place-items:center;font-size:28px;background:#ff6b6b;color:#111;border:2px solid #b33;cursor:pointer;box-shadow:0 4px 0 #b33;user-select:none}
  #bug:active{transform:translate(-50%,-50%) translateY(2px);box-shadow:0 2px 0 #b33}
  .hint{max-width:640px;margin:12px auto;color:var(--muted);font-size:14px}
  .panel{max-width:640px;margin:12px auto;padding:12px;border:2px solid var(--ink);border-radius:8px;background:var(--card)}
  .row{display:flex;gap:8px;align-items:center;margin:8px 0}
  input[type="text"]{flex:1;padding:.6rem;border:2px solid var(--ink);border-radius:6px}
  .muted{color:var(--muted);font-size:13px}
  ul{margin:.25rem 0 0 1rem}
</style>

<body>
  <div class="container">
    <a class="btn back" href="../../">‚Üê Games</a>
    <h1>Bug Busters üêû</h1>

    <div class="hud">
      <div>Time: <span id="time">15.0s</span></div>
      <div>Score: <span id="score">0</span></div>
    </div>

    <div id="playfield" class="playfield" aria-label="Play area"></div>
    <p class="hint">Tap the bug fast! üêû‚ö°</p>

    <!-- –ü–∞–Ω–µ–ª—å –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è -->
    <div id="postGame" class="panel" style="display:none">
      <div class="row"><strong>Time!</strong> Final score: <span id="finalScore">0</span></div>
      <form id="scoreForm" class="row">
        <label for="playerName" class="muted" style="min-width:70px">Name</label>
        <input id="playerName" type="text" maxlength="12" placeholder="Guest" autocomplete="name" />
        <button class="btn primary" type="submit">Submit Score</button>
      </form>
      <div id="scoreStatus" class="muted">Scores are saved on the server.</div>
      <div style="margin-top:8px">
        <strong>Leaderboard</strong>
        <ul id="leaderboard"></ul>
      </div>
      <div class="row"><button id="restartBtn" class="btn">Restart</button></div>
    </div>
  </div>

<script>
const API_BASE = 'https://kids-games-backend.onrender.com';

// DOM
const field = document.getElementById('playfield');
const timeEl = document.getElementById('time');
const scoreEl = document.getElementById('score');
const postGame = document.getElementById('postGame');
const finalScoreEl = document.getElementById('finalScore');
const form = document.getElementById('scoreForm');
const nameInput = document.getElementById('playerName');
const statusEl = document.getElementById('scoreStatus');
const boardEl = document.getElementById('leaderboard');
const restartBtn = document.getElementById('restartBtn');

// State
let score = 0;
let endAt = Date.now() + 15000;
let tickId = 0;

// Create bug
const bug = document.createElement('button');
bug.id = 'bug'; bug.type = 'button'; bug.setAttribute('aria-label','Bug'); bug.textContent = 'üêû';
field.appendChild(bug);

function bounds(){ const r = field.getBoundingClientRect(); return {w:r.width, h:r.height}; }
function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

function moveBug(){
  const { w, h } = bounds();
  const pad = 8 + 56;
  const x = Math.random()*(w - pad*2) + pad;
  const y = Math.random()*(h - pad*2) + pad;
  bug.style.left = x + 'px';
  bug.style.top  = y + 'px';
}

function updateTimer(){
  const ms = clamp(endAt - Date.now(), 0, 15000);
  timeEl.textContent = (ms/1000).toFixed(1) + 's';
  if (ms <= 0){ gameOver(); return; }
  tickId = requestAnimationFrame(updateTimer);
}

function setStatus(msg){ statusEl.textContent = msg; }

async function refreshBoard(){
  boardEl.innerHTML = '‚Ä¶';
  try{
    const res = await fetch(API_BASE + '/scores', {cache:'no-store'});
    const arr = await res.json();
    // —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é
    arr.sort((a,b)=> (b.score??0) - (a.score??0));
    const top = arr.slice(0,10);
    boardEl.innerHTML = top.length ? '' : '<li class="muted">No scores yet.</li>';
    top.forEach((s,i)=>{
      const li = document.createElement('li');
      const nm = (s.name || 'Guest').toString().slice(0,12);
      li.textContent = `${i+1}. ${nm} ‚Äî ${s.score}`;
      boardEl.appendChild(li);
    });
  }catch(_){
    boardEl.innerHTML = '<li class="muted">Cannot load scores.</li>';
  }
}

async function submitScore(){
  const name = (nameInput.value || 'Guest').trim().slice(0,12);
  try{
    setStatus('Saving‚Ä¶');
    const res = await fetch(API_BASE + '/scores', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ name, score })
    });
    if (!res.ok) throw new Error('HTTP '+res.status);
    setStatus('Saved! ‚úÖ');
    await refreshBoard();
  }catch(e){
    setStatus('Failed to save score. Try again later.');
  }
}

function gameOver(){
  cancelAnimationFrame(tickId);
  bug.disabled = true;
  finalScoreEl.textContent = score;
  postGame.style.display = 'block';
  nameInput.focus();
  refreshBoard();
}

bug.addEventListener('click', ()=>{
  score++; scoreEl.textContent = score; moveBug();
});

form.addEventListener('submit', (e)=>{ e.preventDefault(); submitScore(); });
restartBtn.addEventListener('click', ()=>{ location.reload(); });

moveBug();
updateTimer();
addEventListener('resize', ()=> moveBug(), {passive:true});
</script>
</body>
</html>
