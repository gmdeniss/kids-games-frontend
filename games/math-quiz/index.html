<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Math Quiz ⚡</title>
  <link rel="stylesheet" href="../../assets/styles.css">
  <style>
    .container{max-width:980px;margin:32px auto;padding:0 16px}
    .toolbar{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));align-items:end;margin:12px 0 16px}
    fieldset{border:1px solid #0002;border-radius:10px;padding:10px}
    legend{padding:0 6px;color:var(--muted);font-size:12px}
    label{display:flex;gap:8px;align-items:center}
    input[type="number"],select{width:100%;padding:.5rem;border:1px solid #0003;border-radius:8px}
    .btn{display:inline-block;padding:.6rem .9rem;background:#111;color:#fff;border:none;border-radius:10px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:default}
    .pill.small{padding:.25rem .6rem;font-size:12px}
    .quiz{background:var(--card);border:1px solid #0002;border-radius:12px;padding:16px;margin:16px 0}
    .meta{display:flex;flex-wrap:wrap;gap:12px;justify-content:space-between;margin-bottom:8px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media (max-width:700px){ .grid{grid-template-columns:1fr} }
    .item{display:flex;align-items:center;gap:8px;border:1px dashed #0001;border-radius:10px;padding:10px}
    .q{min-width:115px;font-size:18px}
    .ans{flex:1;display:flex;gap:8px;align-items:center}
    .ans input{width:110px;padding:.45rem .55rem;border:2px solid #0002;border-radius:10px;font-size:16px}
    .ans .mark{width:22px;height:22px;border-radius:50%}
    .ok{background:#22c55e33;border:2px solid #22c55e}
    .bad{background:#ef444433;border:2px solid #ef4444}
    .stats{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .stats b{margin:0 4px}
    .muted{color:var(--muted)}
    .hide{display:none !important}
    .footer{margin-top:8px;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
<div class="container">

  <div class="back">
    <a class="pill" href="../../index.html">← Games</a>
  </div>

  <h1>Math Quiz ⚡</h1>

  <form id="controls" class="toolbar">
    <fieldset>
      <legend>Операции</legend>
      <label><input type="checkbox" name="ops" value="+" checked> Сложение (+)</label>
      <label><input type="checkbox" name="ops" value="-"> Вычитание (−)</label>
      <label><input type="checkbox" name="ops" value="*"> Умножение (×)</label>
      <label><input type="checkbox" name="ops" value="/"> Деление (÷)</label>
    </fieldset>

    <fieldset>
      <legend>Сложность</legend>
      <label>Пресет
        <select id="preset">
          <option value="10">≤ 10</option>
          <option value="20" selected>≤ 20</option>
          <option value="100">≤ 100</option>
        </select>
      </label>
      <label style="margin-top:8px;">Max
        <input type="number" id="max" min="5" value="20">
      </label>
      <label style="margin-top:8px;">Задач
        <input type="number" id="count" min="5" max="200" step="5" value="20">
      </label>
    </fieldset>

    <fieldset>
      <legend>Опции</legend>
      <label><input type="checkbox" id="noNegative" checked> Без отрицательных</label>
      <label><input type="checkbox" id="intDiv" checked> Только целые при делении</label>
      <label><input type="checkbox" id="seeded"> Фикс. seed</label>
      <label>Seed <input type="number" id="seed" value="12345"></label>
    </fieldset>

    <fieldset>
      <legend>Проверка и время</legend>
      <label>Проверка
        <select id="checkMode">
          <option value="instant">Мгновенно</option>
          <option value="manual" selected>По кнопке</option>
        </select>
      </label>
      <label style="margin-top:8px;">Таймер
        <select id="timerMode">
          <option value="off" selected>Выкл</option>
          <option value="down">Обратный</option>
          <option value="up">Секундомер</option>
        </select>
      </label>
      <label style="margin-top:8px;">Время (сек)
        <input type="number" id="timerSeconds" min="10" max="600" step="10" value="120">
      </label>
    </fieldset>

    <div>
      <button id="start" type="button" class="btn">Старт / Новая серия</button>
      <button id="checkAll" type="button" class="btn">Проверить всё</button>
      <div class="pills" style="margin-top:8px">
        <span id="best" class="pill small muted">Лучший: —</span>
      </div>
    </div>
  </form>

  <section id="quiz" class="quiz hide" aria-live="polite">
    <div class="meta">
      <div class="stats">
        <span id="timer" class="pill">Время: 0.0s</span>
        <span class="pill">Счёт: <b id="score">0</b>/<span id="total">0</span></span>
        <span id="result" class="pill hide"></span>
      </div>
      <span class="muted">Вариант: <span id="variant">—</span></span>
    </div>
    <div id="grid" class="grid"></div>
    <div class="footer">Подсказка: жми <b>Tab</b> для быстрого ввода. Enter в поле — сразу следующая задача.</div>
  </section>

</div>

<script>
/* ---------- PRNG (Mulberry32) ---------- */
function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296;};}
const rInt = (rng,a,b)=>Math.floor(a + rng()*(b-a+1));

/* ---------- DOM ---------- */
const form = document.getElementById('controls');
const startBtn = document.getElementById('start');
const checkBtn = document.getElementById('checkAll');
const timerEl = document.getElementById('timer');
const scoreEl = document.getElementById('score');
const totalEl = document.getElementById('total');
const resultEl = document.getElementById('result');
const bestEl = document.getElementById('best');
const grid = document.getElementById('grid');
const quiz = document.getElementById('quiz');
const variantEl = document.getElementById('variant');

function getVal(id){ return document.getElementById(id).value; }
function getNum(id){ return parseInt(getVal(id),10); }
function isChecked(id){ return document.getElementById(id).checked; }

function getOptions(){
  const ops = [...form.querySelectorAll('input[name="ops"]:checked')].map(x=>x.value);
  return {
    ops: ops.length? ops : ['+'],
    max: Math.max(5, getNum('max')),
    count: Math.max(5, Math.min(200, getNum('count'))),
    noNegative: isChecked('noNegative'),
    intDiv: isChecked('intDiv'),
    checkMode: getVal('checkMode'),
    timerMode: getVal('timerMode'),
    timerSeconds: Math.max(10, getNum('timerSeconds')),
    seed: isChecked('seeded') ? (getNum('seed')|0) : Math.floor(Math.random()*1e9)
  }
}
document.getElementById('preset').addEventListener('change', e=>{
  document.getElementById('max').value = e.target.value;
});

function keyForBest(o){
  return `quiz_best__ops:${o.ops.sort().join('')}_max:${o.max}_count:${o.count}`;
}
function readBest(o){
  try{ return JSON.parse(localStorage.getItem(keyForBest(o))||'null'); }catch{ return null; }
}
function writeBest(o, rec){
  try{ localStorage.setItem(keyForBest(o), JSON.stringify(rec)); }catch{}
}
function showBest(o){
  const b = readBest(o);
  bestEl.textContent = b ? `Лучший: ${b.score}/${b.total} за ${b.time.toFixed(1)}s` : 'Лучший: —';
}

/* ---------- Генератор задач ---------- */
function makeProblem(rng, ops, max, opt){
  const op = ops[rInt(rng,0,ops.length-1)];
  let a,b,q,ans;
  if(op==='+'){
    a=rInt(rng,0,max); b=rInt(rng,0,max); ans=a+b; q=`${a} + ${b} =`;
  }else if(op==='-'){
    a=rInt(rng,0,max); b=rInt(rng,0,max);
    if(opt.noNegative && b>a){ [a,b]=[b,a]; }
    ans=a-b; q=`${a} − ${b} =`;
  }else if(op==='*'){
    const cap=Math.min(max,12);
    a=rInt(rng,0,cap); b=rInt(rng,0,cap); ans=a*b; q=`${a} × ${b} =`;
  }else{ // '/'
    const cap=Math.min(max,12);
    b=rInt(rng,1,cap);
    ans=rInt(rng,0,cap);
    a=b*ans; q=`${a} ÷ ${b} =`;
  }
  return {q, ans};
}
function makeSet(opt){
  const rng = mulberry32(opt.seed);
  const seen = new Set(), list=[];
  while(list.length<opt.count){
    const p=makeProblem(rng,opt.ops,opt.max,opt);
    const key=p.q+'|'+p.ans;
    if(seen.has(key)) continue;
    seen.add(key); list.push(p);
  }
  return list;
}

/* ---------- Состояние и таймер ---------- */
let current = {opts:null, list:[], start:0, tickId:0, time:0, running:false};
function setScore(n){ scoreEl.textContent=n; }
function setTotal(n){ totalEl.textContent=n; }

function formatSec(s){ return s.toFixed(1)+'s'; }
function startTimer(){
  cancelAnimationFrame(current.tickId);
  current.time = 0;
  const mode=current.opts.timerMode, limit=current.opts.timerSeconds;
  if(mode==='off'){
    current.running=false;
    timerEl.textContent = 'Таймер выключен';
    return;
  }
  current.start = performance.now();
  current.running=true;
  function frame(t){
    if(!current.running) return;
    const ms = (t-current.start);
    if(mode==='up'){
      current.time = ms/1000;
      timerEl.textContent = 'Время: '+formatSec(current.time);
      current.tickId=requestAnimationFrame(frame);
    }else if(mode==='down'){
      const left = Math.max(0, limit - ms/1000);
      current.time = limit - left;
      timerEl.textContent = 'Осталось: '+formatSec(left);
      if(left<=0){ finish(true); } else { current.tickId=requestAnimationFrame(frame); }
    }else{
      current.time = ms/1000;
      timerEl.textContent = 'Время: '+formatSec(current.time);
      current.tickId=requestAnimationFrame(frame);
    }
  }
  current.tickId=requestAnimationFrame(frame);
}
function stopTimer(){ current.running=false; cancelAnimationFrame(current.tickId); }

/* ---------- Рендер квиза ---------- */
function render(list, opt){
  grid.innerHTML = list.map((p,i)=>`
    <label class="item">
      <span class="q">${i+1}. ${p.q}</span>
      <span class="ans">
        <input type="number" inputmode="numeric" data-i="${i}" aria-label="Ответ на задачу ${i+1}">
        <span class="mark" id="mk${i}" aria-hidden="true"></span>
      </span>
    </label>
  `).join('');
  setTotal(list.length);
  setScore(0);
  resultEl.classList.add('hide');
  quiz.classList.remove('hide');

  // поведение ввода
  grid.querySelectorAll('input').forEach((inp, idx, arr)=>{
    inp.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){ e.preventDefault(); (arr[idx+1]||arr[0]).focus(); }
    });
    if(opt.checkMode==='instant'){
      inp.addEventListener('input', ()=>checkOne(idx));
    }
  });
  grid.querySelector('input')?.focus();
}

/* ---------- Проверка ---------- */
function checkOne(i){
  const val = grid.querySelector(`input[data-i="${i}"]`).value;
  const mark = document.getElementById('mk'+i);
  const ok = (val!=='' && Number(val)===current.list[i].ans);
  mark.className = 'mark ' + (ok? 'ok':'bad');
  recount();
}
function recount(){
  const n = current.list.length;
  let good=0;
  for(let i=0;i<n;i++){
    const inp=grid.querySelector(`input[data-i="${i}"]`);
    if(inp && Number(inp.value)===current.list[i].ans) good++;
  }
  setScore(good);
}
function checkAll(){
  const n=current.list.length;
  for(let i=0;i<n;i++){ checkOne(i); }
}

/* ---------- Старт/Финиш ---------- */
function lockControls(lock){
  [...form.elements].forEach(el=>{
    if(el.id==='checkAll') return;
    el.disabled=lock && el.id!=='checkAll';
  });
}
function startQuiz(){
  const opts=getOptions();
  current.opts=opts;
  current.list=makeSet(opts);
  variantEl.textContent = opts.seed;
  showBest(opts);

  render(current.list, opts);
  lockControls(true);
  startTimer();
}
function finish(auto=false){
  stopTimer();
  checkAll();
  lockControls(false);
  const score=parseInt(scoreEl.textContent,10), total=parseInt(totalEl.textContent,10);
  resultEl.classList.remove('hide');
  resultEl.textContent = `${auto?'Время вышло — ':''}Результат: ${score}/${total} за ${current.time.toFixed(1)}s`;

  // лучший результат
  const best=readBest(current.opts);
  if(!best || score>best.score || (score===best.score && current.time<best.time)){
    writeBest(current.opts, {score, total, time:current.time});
    showBest(current.opts);
  }
}

/* ---------- События ---------- */
startBtn.addEventListener('click', ()=>{
  finishCleanup(); // если что-то было
  startQuiz();
});
checkBtn.addEventListener('click', ()=>finish(false));

function finishCleanup(){ stopTimer(); }

/* авто-синхронизация max с пресетом один раз */
document.getElementById('preset').dispatchEvent(new Event('change'));

/* старт без авто — пусть кликают Старт */
</script>
</body>
</html>
